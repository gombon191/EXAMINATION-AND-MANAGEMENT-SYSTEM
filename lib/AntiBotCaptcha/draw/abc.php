<?php /* AntiBotCaptcha v1.0 - Banchar Paseelatesang (banchar_pa@yahoo.com) - Credit: Jose Rodriguez */
session_start();class AntiBotCaptcha{private $fonts=array('Antykwa'=>array('spacing'=>-3,'minSize'=>27,'maxSize'=>30,'font'=>'AntykwaBold.ttf'),'Candice'=>array('spacing'=>-1.5,'minSize'=>28,'maxSize'=>31,'font'=>'Candice.ttf'),'DingDong'=>array('spacing'=>-2,'minSize'=>24,'maxSize'=>30,'font'=>'Ding-DongDaddyO.ttf'),'Duality'=>array('spacing'=>-2,'minSize'=>30,'maxSize'=>38,'font'=>'Duality.ttf'),'Heineken'=>array('spacing'=>-2,'minSize'=>24,'maxSize'=>34,'font'=>'Heineken.ttf'),'Jura'=>array('spacing'=>-2,'minSize'=>28,'maxSize'=>32,'font'=>'Jura.ttf'),'StayPuft'=>array('spacing'=>-1.5,'minSize'=>28,'maxSize'=>32,'font'=>'StayPuft.ttf'),'Times'=>array('spacing'=>-2,'minSize'=>28,'maxSize'=>34,'font'=>'TimesNewRomanBold.ttf'),'VeraSans'=>array('spacing'=>-1,'minSize'=>20,'maxSize'=>28,'font'=>'VeraSansBold.ttf'));private $width=250;private $height=60;private $path="";private $textLength=6;private $session_var='captcha';private $bgColors=array(array(255,255,255));private $textColors=array(array(27,78,181),array(22,163,35),array(214,36,7));private $shadowColor=null;private $lineWidth=0;private $Yperiod=12;private $Yamplitude=14;private $Xperiod=11;private $Xamplitude=5;private $maxRotation=8;private $scale=2;private $blur=false;private $debug=false;private $show_reload=true;private $img;public function __construct($config=array()){$this->path=dirname(__FILE__);$this->textColors=(isset($_SESSION['text_color']))?$_SESSION['text_color']:$this->textColors;$this->bgColors=(isset($_SESSION['bg_color']))?$_SESSION['bg_color']:$this->bgColors;$this->textLength=(isset($_SESSION['text_length']))?$_SESSION['text_length']:$this->textLength;$this->width=(($this->textLength*30)<200)?$this->textLength*30:200;$this->show_reload=(isset($_SESSION['show_reload']))?$_SESSION['show_reload']:$this->show_reload;$this->session_var=(isset($_SESSION['session_var']))?$_SESSION['session_var']:$this->session_var;}public function CreateImage(){$ini=microtime(true);$this->imageAllocate();$text=$this->GetCaptchaText();$fontcfg=$this->fonts[array_rand($this->fonts)];$this->WriteText($text,$fontcfg);$_SESSION[$this->session_var]=$text;if(!empty($this->lineWidth)){$this->WriteLine();}$this->WaveImage();if($this->blur&&function_exists('imagefilter')){imagefilter($this->img,IMG_FILTER_GAUSSIAN_BLUR);}$this->ReduceImage();if($this->debug){imagestring($this->img,1,1,$this->height-8,"$text{$fontcfg['font']} ".round((microtime(true)-$ini)*1000)."ms",$this->GdFgColor);}$this->MergeReload();$this->WriteImage();$this->Cleanup();}private function ImageAllocate(){if(!empty($this->img)){imagedestroy($this->img);}$this->img=imagecreatetruecolor($this->width*$this->scale,$this->height*$this->scale);$bg=$this->bgColors[mt_rand(0,sizeof($this->bgColors)-1)];$this->GdBgColor=imagecolorallocate($this->img,$bg[0],$bg[1],$bg[2]);imagefilledrectangle($this->img,0,0,$this->width*$this->scale,$this->height*$this->scale,$this->GdBgColor);$color=$this->textColors[mt_rand(0,sizeof($this->textColors)-1)];$this->GdFgColor=imagecolorallocate($this->img,$color[0],$color[1],$color[2]);if(!empty($this->shadowColor)&&is_array($this->shadowColor)&&sizeof($this->shadowColor)>=3){$this->GdShadowColor=imagecolorallocate($this->img,$this->shadowColor[0],$this->shadowColor[1],$this->shadowColor[2]);}}private function GetCaptchaText(){$length=$this->textLength;$chars="bcdfghjklmnpqrstvwxyz";$vowels="aeiou";$text="";$vowel=rand(0,1);for($i=0;$i<$length;$i++){if($vowel){$text.=substr($vowels,mt_rand(0,4),1);}else{$text.=substr($chars,mt_rand(0,20),1);}$vowel=!$vowel;}return $text;}private function WriteLine(){$x1=$this->width*$this->scale*.15;$x2=$this->textFinalX;$y1=rand($this->height*$this->scale*.40,$this->height*$this->scale*.65);$y2=rand($this->height*$this->scale*.40,$this->height*$this->scale*.65);$width=$this->lineWidth/2*$this->scale;for($i=$width*-1;$i<=$width;$i++){imageline($this->img,$x1,$y1+$i,$x2,$y2+$i,$this->GdFgColor);}}private function WriteText($text,$fontcfg=array()){if(empty($fontcfg)){$fontcfg=$this->fonts[array_rand($this->fonts)];}$fontfile=dirname($this->path)."/fonts/".$fontcfg['font'];$lettersMissing=$this->textLength-strlen($text);$fontSizefactor=1+($lettersMissing*0.09);$x=20*$this->scale;$y=round(($this->height*27/40)*$this->scale);$length=strlen($text);for($i=0;$i<$length;$i++){$degree=rand($this->maxRotation*-1,$this->maxRotation);$fontsize=rand($fontcfg['minSize'],$fontcfg['maxSize'])*$this->scale*$fontSizefactor;$letter=substr($text,$i,1);if($this->shadowColor){$coords=imagettftext($this->img,$fontsize,$degree,$x+$this->scale,$y+$this->scale,$this->GdShadowColor,$fontfile,$letter);}$coords=imagettftext($this->img,$fontsize,$degree,$x,$y,$this->GdFgColor,$fontfile,$letter);$x+=($coords[2]-$x)+($fontcfg['spacing']*$this->scale);}$this->textFinalX=$x;}private function WaveImage(){$xp=$this->scale*$this->Xperiod*rand(1,3);$k=rand(0,100);for($i=0;$i<($this->width*$this->scale);$i++){imagecopy($this->img,$this->img,$i-1,sin($k+$i/$xp)*($this->scale*$this->Xamplitude),$i,0,1,$this->height*$this->scale);}$k=rand(0,100);$yp=$this->scale*$this->Yperiod*rand(1,2);for($i=0;$i<($this->height*$this->scale);$i++){imagecopy($this->img,$this->img,sin($k+$i/$yp)*($this->scale*$this->Yamplitude),$i-1,0,$i,$this->width*$this->scale,1);}}private function ReduceImage(){$imResampled=imagecreatetruecolor($this->width,$this->height);imagecopyresampled($imResampled,$this->img,0,0,0,0,$this->width,$this->height,$this->width*$this->scale,$this->height*$this->scale);imagedestroy($this->img);$this->img=$imResampled;}private function MergeReload(){if($this->show_reload){$img_mrg=imagecreatefromgif($this->path."/recaptcha.gif");$white=imagecolorallocate($this->img,255,255,255);$cx=$this->width-imagesx($img_mrg)/2;$cy=$this->height-imagesy($img_mrg)/2;imagefilledellipse($this->img,$cx,$cy,imagesx($img_mrg)+3,imagesy($img_mrg)+3,$white);$x=$this->width-imagesx($img_mrg)-1;$y=$this->height-imagesy($img_mrg)-1;imagecopymerge($this->img,$img_mrg,$x,$y,0,0,imagesx($img_mrg),imagesy($img_mrg),100);}}private function WriteImage(){header("Content-type: image/jpeg");imagejpeg($this->img,null,100);}private function Cleanup(){imagedestroy($this->img);}}$abcaptcha=new AntiBotCaptcha();$abcaptcha->CreateImage();
?>